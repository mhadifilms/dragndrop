name: Build and Release

on:
  push:
    tags:
      - 'v*'  # Triggers on version tags like v1.0.0
  workflow_dispatch:  # Allow manual trigger
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

env:
  APP_NAME: DragNDrop
  BUNDLE_ID: com.dragndrop.app

jobs:
  build:
    name: Build and Package
    runs-on: macos-15  # macOS Sequoia

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Get version from tag or input
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            # Extract version from tag (remove 'v' prefix)
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Cache Swift packages
        uses: actions/cache@v4
        with:
          path: .build
          key: ${{ runner.os }}-swift-${{ hashFiles('Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-swift-

      - name: Build release
        run: |
          swift build --configuration release

      - name: Run tests
        run: |
          swift test
        continue-on-error: true  # Don't fail release if tests fail

      - name: Create app bundle
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"

          mkdir -p dist
          APP_BUNDLE="dist/${{ env.APP_NAME }}.app"

          # Create bundle structure
          mkdir -p "$APP_BUNDLE/Contents/MacOS"
          mkdir -p "$APP_BUNDLE/Contents/Resources"

          # Copy executable
          cp ".build/release/dragndrop-app" "$APP_BUNDLE/Contents/MacOS/${{ env.APP_NAME }}"

          # Create Info.plist
          cat > "$APP_BUNDLE/Contents/Info.plist" << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleDevelopmentRegion</key>
              <string>en</string>
              <key>CFBundleExecutable</key>
              <string>${{ env.APP_NAME }}</string>
              <key>CFBundleIconFile</key>
              <string>AppIcon</string>
              <key>CFBundleIdentifier</key>
              <string>${{ env.BUNDLE_ID }}</string>
              <key>CFBundleInfoDictionaryVersion</key>
              <string>6.0</string>
              <key>CFBundleName</key>
              <string>${{ env.APP_NAME }}</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>CFBundleShortVersionString</key>
              <string>$VERSION</string>
              <key>CFBundleVersion</key>
              <string>$VERSION</string>
              <key>LSMinimumSystemVersion</key>
              <string>15.0</string>
              <key>LSUIElement</key>
              <true/>
              <key>NSHighResolutionCapable</key>
              <true/>
              <key>NSSupportsAutomaticTermination</key>
              <false/>
              <key>NSSupportsSuddenTermination</key>
              <false/>
              <key>NSPrincipalClass</key>
              <string>NSApplication</string>
              <key>LSApplicationCategoryType</key>
              <string>public.app-category.utilities</string>
              <key>CFBundleURLTypes</key>
              <array>
                  <dict>
                      <key>CFBundleURLName</key>
                      <string>${{ env.BUNDLE_ID }}</string>
                      <key>CFBundleURLSchemes</key>
                      <array>
                          <string>dragndrop</string>
                      </array>
                  </dict>
              </array>
          </dict>
          </plist>
          EOF

          # Create PkgInfo
          echo -n "APPL????" > "$APP_BUNDLE/Contents/PkgInfo"

          # Copy icon if it exists
          if [ -f "Resources/AppIcon.icns" ]; then
            cp "Resources/AppIcon.icns" "$APP_BUNDLE/Contents/Resources/"
          fi

          echo "App bundle created"

      - name: Create DMG
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          DMG_NAME="${{ env.APP_NAME }}-${VERSION}"

          # Create temp folder for DMG contents
          mkdir -p dist/dmg-temp
          cp -R "dist/${{ env.APP_NAME }}.app" dist/dmg-temp/
          ln -s /Applications dist/dmg-temp/Applications

          # Create DMG
          hdiutil create -srcfolder dist/dmg-temp \
            -volname "${{ env.APP_NAME }}" \
            -fs HFS+ \
            -format UDRW \
            -size 50m \
            dist/temp.dmg

          # Convert to compressed DMG
          hdiutil convert dist/temp.dmg \
            -format UDZO \
            -imagekey zlib-level=9 \
            -o "dist/${DMG_NAME}.dmg"

          # Clean up
          rm -f dist/temp.dmg
          rm -rf dist/dmg-temp

          echo "DMG created: dist/${DMG_NAME}.dmg"
          ls -la dist/

      - name: Create ZIP archive
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          cd dist
          zip -r "${{ env.APP_NAME }}-${VERSION}.zip" "${{ env.APP_NAME }}.app"
          cd ..
          echo "ZIP created"
          ls -la dist/

      - name: Generate checksums
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          cd dist
          shasum -a 256 "${{ env.APP_NAME }}-${VERSION}.dmg" > "${{ env.APP_NAME }}-${VERSION}.dmg.sha256"
          shasum -a 256 "${{ env.APP_NAME }}-${VERSION}.zip" > "${{ env.APP_NAME }}-${VERSION}.zip.sha256"
          cat *.sha256
          cd ..

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-${{ steps.version.outputs.VERSION }}
          path: |
            dist/*.dmg
            dist/*.zip
            dist/*.sha256
          retention-days: 30

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-${{ steps.version.outputs.VERSION }}
          path: dist/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: ${{ env.APP_NAME }} v${{ steps.version.outputs.VERSION }}
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
          generate_release_notes: true
          files: |
            dist/${{ env.APP_NAME }}-${{ steps.version.outputs.VERSION }}.dmg
            dist/${{ env.APP_NAME }}-${{ steps.version.outputs.VERSION }}.zip
            dist/${{ env.APP_NAME }}-${{ steps.version.outputs.VERSION }}.dmg.sha256
            dist/${{ env.APP_NAME }}-${{ steps.version.outputs.VERSION }}.zip.sha256
          body: |
            ## Installation

            1. Download `${{ env.APP_NAME }}-${{ steps.version.outputs.VERSION }}.dmg`
            2. Open the DMG file
            3. Drag ${{ env.APP_NAME }} to your Applications folder
            4. Launch from Applications or Spotlight

            ## Requirements

            - macOS 15.0 (Sequoia) or later
            - AWS account with S3 access

            ## Verify Download

            ```bash
            shasum -a 256 -c ${{ env.APP_NAME }}-${{ steps.version.outputs.VERSION }}.dmg.sha256
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
